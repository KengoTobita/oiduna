# ADR-0001: SuperDirt supernovaマルチコア処理の採用

## ステータス

承認済み

## 日付

- 作成: 2026-02-22
- 承認: 2026-02-22

## コンテキスト

### 問題

Oiduna v1ではSuperColliderのデフォルトオーディオサーバー`scsynth`を使用していましたが、シングルコア処理のため複雑なパターン再生時にCPU使用率が高くなり、オーディオドロップアウトのリスクがありました。現代のマルチコアCPU（4コア以上）の性能を十分に活用できていませんでした。

### 制約

- SuperColliderエコシステムとの互換性維持
- 既存のSynthDefやサンプルライブラリとの互換性
- SuperDirt（TidalCycles）プロトコルの互換性
- 開発時間: Phase 1実装は1週間以内

### 要件

- **機能要件:**
  - マルチコアCPU活用による処理能力向上
  - 既存のOiduna v1パターンとの後方互換性
  - SuperDirt OSCプロトコルの維持

- **非機能要件:**
  - CPU使用率の改善（シングルコア → マルチコア分散）
  - レイテンシ悪化なし（目標: <10ms）
  - 設定の簡易性（ユーザーが容易に設定変更可能）

## 決定事項

**SuperColliderのオーディオサーバーを`scsynth`から`supernova`に変更する。**

SuperColliderの起動スクリプト（`superdirt_startup_oiduna_v2.scd`）で以下を設定：

```supercollider
s.options.program = "supernova";  // マルチコア対応サーバー
s.options.threads = 4;             // スレッド数（CPUコア数に応じて調整）
```

**実装方法:**

1. SuperCollider起動スクリプトにsupernova設定を追加
2. スレッド数をCPUコア数に応じて設定（デフォルト: 4）
3. 従来のscsynth設定はコメントアウトで残し、切り替え可能にする
4. ドキュメントにCPUコア数別の推奨設定を記載

**成功基準:**

- 複雑なパターン再生時のCPU使用率が複数コアに分散
- `s.avgCPU`が従来比で低下
- オーディオドロップアウトの減少
- 既存パターンが問題なく再生可能

## 理由

1. **性能向上:** マルチコアCPUの性能を活用し、より複雑なパターンを安定再生可能
2. **SuperCollider公式サポート:** `supernova`はSuperCollider 3.10+で公式サポート
3. **後方互換性:** SynthDef、サンプル、OSCプロトコルはすべて互換
4. **設定の容易性:** 起動スクリプトの2行変更で適用可能
5. **フォールバック:** supernovaが使えない環境でも`scsynth`に戻せる

## 代替案

### 案1: Rust製オーディオエンジンの開発

**概要:** SuperColliderを使わず、Rustで独自のオーディオエンジンを実装

**長所:**
- 最適化の自由度が高い
- レイテンシの最小化が可能
- メモリ安全性（Rustの利点）
- マルチコア制御の完全な自由

**短所:**
- 開発コストが非常に高い（数ヶ月〜1年規模）
- SuperColliderエコシステムとの互換性喪失
- 既存SynthDefが使用不可
- SuperDirtサンプルライブラリの再実装が必要
- デバッグ・メンテナンスコストが高い

**却下理由:**
Phase 1の目標は「既存システムの段階的改善」であり、全面書き換えは時期尚早。Phase 2+で部分的なRust化（タイミングエンジンのみ等）を検討する方が現実的。

### 案2: scsynth + 外部マルチプロセッシング

**概要:** scsynth（シングルコア）を複数プロセス起動し、Pythonレイヤーでロードバランシング

**長所:**
- scsynth自体は変更不要
- プロセス分離によるクラッシュ時の影響範囲限定

**短所:**
- プロセス間通信のオーバーヘッド
- 複雑なロードバランシングロジックが必要
- SuperDirtのグローバルエフェクト（リバーブ等）の共有が困難
- メモリ使用量増加（サンプルライブラリの重複ロード）
- 設定・デバッグが複雑

**却下理由:**
複雑性とオーバーヘッドのデメリットが大きい。supernovaの方がシンプルで効果的。

### 案3: 変更なし（scsynth継続）

**概要:** scsynth（シングルコア）のまま、Pythonレイヤーの最適化のみ

**長所:**
- リスクゼロ（既存システム維持）
- 変更コストゼロ

**短所:**
- CPU使用率問題の根本解決にならない
- 複雑なパターンで性能限界に達する
- 競合製品（TidalCycles等）との性能差が開く

**却下理由:**
問題の先送りに過ぎず、将来的に必ず対処が必要になる。早期に対応した方が移行コストが低い。

## 影響

### プラスの影響

- **性能向上:** CPU使用率が複数コアに分散、ドロップアウト減少
- **スケーラビリティ:** より多くのトラック・エフェクトを同時処理可能
- **ユーザー体験向上:** 安定した再生、より複雑なパターン作成が可能
- **将来性:** SuperColliderコミュニティの方向性と一致

### マイナスの影響

- **学習コスト:** ユーザーがsupernovaの存在を認識する必要
- **デバッグ:** マルチスレッド特有のバグの可能性（まれ）
- **環境依存:** 古いSuperColliderバージョンでは動作しない

### リスク

- **リスク:** supernovaがインストールされていない環境での起動失敗
  - **軽減策:** ドキュメントで明記、フォールバック設定を提供

- **リスク:** マルチスレッド特有のタイミング問題
  - **軽減策:** SuperColliderコミュニティで十分に検証済み、大きな問題報告なし

- **リスク:** 特定のUGenでマルチスレッド非対応
  - **軽減策:** SuperDirt標準UGenは全て対応済み、カスタムUGen使用時は要確認

### 移行コスト

- **工数:** 約1日（起動スクリプト変更、ドキュメント作成、テスト）
- **技術的負債:** なし（SuperCollider公式機能の利用）
- **学習コスト:** ユーザー側は基本的に透過的、設定変更のみ

## 検証方法

決定が正しかったかどうかを以下で検証：

1. **CPU使用率測定:**
   ```supercollider
   s.avgCPU;  // 平均CPU使用率
   s.peakCPU; // ピークCPU使用率
   ```
   → 複数コアに分散していることを`htop`等で確認

2. **オーディオドロップアウト頻度:**
   - 複雑なパターンを長時間再生
   - ドロップアウト発生頻度を記録（v1との比較）

3. **レイテンシ測定:**
   - OSC送信からサウンド出力までの遅延を測定
   - 目標: <10ms（v1と同等以下）

4. **互換性テスト:**
   - v1の既存パターンをすべて再生
   - エラー・音質変化がないことを確認

5. **ユーザーフィードバック:**
   - β版ユーザーにテスト依頼
   - パフォーマンス改善の体感を収集

## 関連するADR

- [ADR-0003: Python vs Rust タイミングエンジン] - Rust化はPhase 2+で検討

## 参考資料

- [SuperCollider supernova documentation](https://doc.sccode.org/Guides/News-3_7.html#supernova)
- [TidalCycles SuperDirt with supernova](https://tidalcycles.org/docs/configuration/superdirt/)
- [Oiduna Phase 1 Implementation Plan](../../oiduna/docs/PHASE1_IMPLEMENTATION_SUMMARY.md)

## メモ

### 将来の検討事項

- スレッド数の動的調整（CPU負荷に応じて自動調整）
- ユーザーがGUIで簡単にスレッド数を変更できる仕組み
- Phase 2+でタイミングエンジンのRust化を検討（supernovaは維持）

### 実装時の注意点

- ドキュメントに「supernovaが使えない環境でのフォールバック方法」を明記
- スレッド数の推奨値をCPUコア数別に記載（4/8/16コア等）
- 初回起動時にsupernova使用可能かチェックし、ログ出力

## 履歴

- 2026-02-22: 初稿作成（ステータス: 提案中）
- 2026-02-22: Phase 1実装完了により承認（ステータス: 承認済み）

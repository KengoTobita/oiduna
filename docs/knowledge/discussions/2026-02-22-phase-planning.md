# Oiduna v2 フェーズプランニング - 機能整理ディスカッション

**日付:** 2026-02-22
**参加者:** Claude Code, ユーザー
**目的:** Phase 2以降の機能を整理し、各フェーズの範囲を明確化

## これまでに出てきた「やりたいこと」全リスト

### Phase 1（✓ 完了）

1. ✓ supernova マルチコア処理統合
2. ✓ リモートSynthDefロード（HTTP API）
3. ✓ リモートサンプルロード（HTTP API）
4. ✓ バッファリストAPI
5. ✓ OSC確認プロトコル
6. ✓ 包括的テスト・ドキュメント

---

## 未実装機能の分類

### A. 信頼性・品質向上

#### A1. リクエスト管理
- [ ] リクエストID導入（UUID生成、確認マッチング改善）
- [ ] リクエストキュー管理（高負荷時のバッファリング）
- [ ] 優先度付きキュー（重要なコマンドを優先処理）

#### A2. 検証・バリデーション
- [ ] SynthDef構文検証（送信前チェック）
- [ ] SynthDefパラメータ検証
- [ ] 既知の問題パターン検出
- [ ] サンプルファイル検証（フォーマット、破損チェック）

#### A3. エラーハンドリング
- [ ] より詳細なエラーメッセージ
- [ ] エラーログ集約・分析
- [ ] リトライ機構（一時的なエラー対応）
- [ ] Graceful degradation（部分的な機能停止対応）

#### A4. 監視・ヘルスチェック
- [ ] OSCレシーバーヘルスチェック
- [ ] SuperColliderヘルスチェック強化
- [ ] メトリクス収集（Prometheus等）
- [ ] アラート機能（異常検知）

### B. パフォーマンス最適化

#### B1. タイミング精度
- [ ] タイミング精度測定ツール実装
- [ ] ベンチマーク確立（±5ms基準）
- [ ] 長時間安定性テスト（1時間+）
- [ ] GC影響の測定・軽減

#### B2. Python最適化
- [ ] プロファイリング実施（cProfile, py-spy）
- [ ] ボトルネック特定・改善
- [ ] asyncio最適化
- [ ] メモリ使用量削減

#### B3. Rust化検討（条件付き）
- [ ] タイミングエンジンのみRust化（PyO3）
- [ ] パフォーマンス比較（Python vs Rust）
- [ ] 段階的移行戦略
- [ ] フォールバック機構

### C. 機能拡張

#### C1. サンプル管理
- [ ] サンプルメタデータ取得（長さ、フォーマット、チャンネル数）
- [ ] メタデータキャッシュ機構
- [ ] サンプルプレビュー機能
- [ ] サンプル検索・フィルタリング
- [ ] サンプルタグ付け

#### C2. SynthDef管理
- [ ] ロード済みSynthDefリスト
- [ ] SynthDefアンロード機能
- [ ] SynthDefバージョン管理
- [ ] SynthDefテンプレート提供
- [ ] SynthDefプリセット管理

#### C3. リアルタイム通知
- [ ] WebSocket統合
- [ ] サンプルロード進捗通知
- [ ] SynthDefコンパイル進捗通知
- [ ] エラー通知（リアルタイム）
- [ ] パフォーマンスメトリクスストリーム

#### C4. パターン機能拡張
- [ ] より複雑なパターン構文サポート
- [ ] パターン変換・ジェネレーター
- [ ] ライブコーディング用ショートカット
- [ ] パターンプリセット

#### C5. エフェクト管理
- [ ] エフェクトチェーン管理
- [ ] エフェクトプリセット
- [ ] エフェクトパラメータのライブ変更
- [ ] カスタムエフェクトロード

### D. 開発者体験（DX）

#### D1. ツール・ユーティリティ
- [ ] CLIツール拡張
- [ ] デバッグモード強化
- [ ] ロギング改善
- [ ] トレーシング（OpenTelemetry等）

#### D2. ドキュメント
- [ ] APIリファレンス自動生成
- [ ] インタラクティブチュートリアル
- [ ] ビデオチュートリアル
- [ ] ベストプラクティスガイド
- [ ] トラブルシューティングガイド拡充

#### D3. テスト
- [ ] 統合テスト拡充（E2E）
- [ ] パフォーマンステスト自動化
- [ ] CI/CD パイプライン構築
- [ ] テストカバレッジ向上（目標90%+）

### E. デプロイ・運用

#### E1. デプロイ
- [ ] Docker化
- [ ] docker-compose構成
- [ ] Kubernetes対応（将来）
- [ ] 環境別設定管理

#### E2. セキュリティ
- [ ] 認証・認可（API）
- [ ] レート制限
- [ ] 入力サニタイゼーション強化
- [ ] セキュリティ監査

#### E3. スケーラビリティ
- [ ] 水平スケーリング検討
- [ ] ロードバランシング
- [ ] セッション管理（複数インスタンス）

### F. Web UI（Phase 3想定）

#### F1. 基本UI
- [ ] Monaco Editor統合
- [ ] パターンエディタ
- [ ] リアルタイムプレビュー
- [ ] トラック管理UI

#### F2. 高度なUI
- [ ] ビジュアルパターンエディタ
- [ ] サンプルブラウザ
- [ ] SynthDefブラウザ
- [ ] パフォーマンスダッシュボード

---

## フェーズ分け提案（草案）

### Phase 2: 信頼性・品質向上（推定: 2-3週間）

**目標:** 本番環境で安定運用できる品質に到達

**優先度: 高**

1. **リクエストID導入**
   - 同時リクエストの完全サポート
   - 確認マッチングの信頼性向上
   - 工数: 2-3日

2. **SynthDef検証**
   - 構文チェック（送信前）
   - 基本的なパラメータ検証
   - 工数: 3-4日

3. **サンプルメタデータ**
   - 長さ、フォーマット、チャンネル数取得
   - キャッシング機構
   - 工数: 2-3日

4. **エラーハンドリング強化**
   - 詳細なエラーメッセージ
   - リトライ機構
   - 工数: 2日

5. **ヘルスチェック強化**
   - OSCレシーバー監視
   - SuperCollider状態監視
   - 工数: 1-2日

6. **統合テスト**
   - E2Eテスト追加
   - CI/CD基盤構築
   - 工数: 3-4日

**Phase 2成果物:**
- リクエストID対応API
- SynthDef検証機能
- サンプルメタデータAPI
- 統合テスト suite
- CI/CDパイプライン

**Phase 2完了条件:**
- すべてのAPIがリクエストID対応
- E2Eテストが全て通過
- ドキュメント更新完了

---

### Phase 2.5: パフォーマンス測定・最適化（推定: 1-2週間）

**目標:** タイミング精度のベースライン確立、ボトルネック特定

**優先度: 中**

1. **タイミング精度測定**
   - 測定ツール実装
   - ベンチマーク確立
   - 長時間安定性テスト
   - 工数: 3-4日

2. **プロファイリング**
   - cProfile/py-spy実行
   - ボトルネック特定
   - 工数: 2-3日

3. **Python最適化**
   - 特定されたボトルネック改善
   - asyncio最適化
   - 工数: 3-5日

4. **Rust化判断**
   - 測定結果を元に判断
   - 必要ならPhase 3へ
   - 工数: 1日（判断のみ）

**Phase 2.5成果物:**
- タイミング精度レポート
- パフォーマンスベンチマーク
- 最適化されたコード
- Rust化判断ドキュメント（ADR）

**Phase 2.5完了条件:**
- タイミング精度±5ms以内を95%以上達成
- ボトルネック特定・文書化
- Rust化の要否を決定

---

### Phase 3: 機能拡張 + Web UI（推定: 4-6週間）

**目標:** ユーザー体験向上、Web UIによるアクセス性向上

**優先度: 中〜低**

#### 3A. 機能拡張（2-3週間）

1. **SynthDef管理機能**
   - リスト、アンロード、バージョン管理
   - 工数: 3-4日

2. **サンプル管理機能**
   - 検索、フィルタリング、タグ付け
   - 工数: 3-4日

3. **WebSocket統合**
   - リアルタイム通知基盤
   - 進捗通知、エラー通知
   - 工数: 4-5日

4. **エフェクト管理**
   - エフェクトチェーン、プリセット
   - 工数: 3-4日

#### 3B. Web UI（2-3週間）

1. **基本UIフレームワーク**
   - React/Vue.js等選定
   - Monaco Editor統合
   - 工数: 5-7日

2. **パターンエディタ**
   - コードエディタ
   - シンタックスハイライト
   - 工数: 3-4日

3. **管理UI**
   - サンプルブラウザ
   - SynthDefブラウザ
   - トラック管理
   - 工数: 5-7日

**Phase 3成果物:**
- SynthDef/サンプル管理API
- WebSocket通知機能
- Web UI（基本機能）
- ユーザーガイド

---

### Phase 4（将来）: Rust化・スケーラビリティ

**条件:** Phase 2.5でRust化が必要と判断された場合のみ

1. **タイミングエンジンRust化**
   - PyO3統合
   - パフォーマンス比較
   - 工数: 1-2ヶ月

2. **スケーラビリティ対応**
   - 水平スケーリング
   - ロードバランシング
   - 工数: 2-3週間

3. **認証・認可**
   - JWT等の導入
   - ユーザー管理
   - 工数: 2-3週間

---

## フェーズ間の依存関係

```
Phase 1 (完了)
    ↓
Phase 2 (信頼性)
    ↓
Phase 2.5 (測定・最適化)
    ↓
    ├─→ Phase 3 (機能拡張 + Web UI)
    └─→ Phase 4 (Rust化) ← 条件付き
```

---

## 議論ポイント

### 1. Phase 2の範囲は適切か？

**提案内容:**
- リクエストID導入
- SynthDef検証
- サンプルメタデータ
- エラーハンドリング強化
- ヘルスチェック強化
- 統合テスト

**質問:**
- これで「本番運用可能な品質」に達するか？
- 追加すべき機能はあるか？
- 逆に、Phase 3に回せる機能はあるか？

### 2. Phase 2.5（測定フェーズ）は必要か？

**代替案:**
- Phase 2に統合
- Phase 3に統合
- 独立したフェーズとして実施（提案）

**理由:**
- Rust化判断には測定データが必須
- 最適化は測定後に実施すべき
- 独立フェーズで集中して測定

### 3. Phase 3の優先度は？

**現状提案:** Phase 2完了後に着手

**代替案:**
- Phase 3Aのみ先行（Web UIは後回し）
- Web UIを最優先（ユーザー体験重視）
- Phase 3全体を後回し（Phase 4を優先）

**判断基準:**
- ユーザーの要望
- 使用シーン（CLI中心 vs Web中心）
- 開発リソース

### 4. Rust化は本当に必要か？

**Phase 2.5で判断すべき点:**
- タイミング精度が±5ms以内を達成できているか
- Python最適化で改善可能か
- Rust化のコスト対効果

**Rust化しない場合:**
- Phase 4はスキップ
- Phase 3から直接運用フェーズへ

### 5. 各Phase間の移行基準は明確か？

**提案:**

**Phase 1 → Phase 2:**
- ✓ Phase 1機能完了（完了済み）

**Phase 2 → Phase 2.5:**
- リクエストID対応完了
- 統合テストsuite構築完了
- ドキュメント更新完了

**Phase 2.5 → Phase 3/4:**
- タイミング精度ベンチマーク完了
- Rust化要否判断完了
- 最適化完了

**Phase 3 → 運用:**
- Web UI基本機能完了
- ユーザーガイド完成
- β版ユーザーフィードバック反映

---

## ユーザーへの質問

### Q1. Phase 2の範囲について

以下の機能で「本番運用可能」と言えるか？

- リクエストID対応
- SynthDef検証
- サンプルメタデータ
- エラーハンドリング強化
- ヘルスチェック
- 統合テスト

**追加すべき機能はあるか？**

### Q2. Phase 2.5の必要性

測定・最適化を独立フェーズにするか、Phase 2に統合するか？

**選択肢:**
- A: 独立フェーズ（提案）- 集中して測定・判断
- B: Phase 2に統合 - フェーズ数を減らす
- C: Phase 3に統合 - Phase 2を早く完了

### Q3. Web UIの優先度

Phase 3でWeb UIをどう扱うか？

**選択肢:**
- A: 機能拡張とWeb UIを並行（提案）
- B: Web UIを最優先（ユーザー体験重視）
- C: 機能拡張のみ先行（Web UIは後回し）

### Q4. Rust化の方針

Rust化について：

**選択肢:**
- A: Phase 2.5で測定後に判断（提案）
- B: Rust化は当面見送り（Python最適化に集中）
- C: Phase 2完了後すぐにRust化着手

### Q5. 他に重要な機能はあるか？

上記リストに含まれていない重要な機能はあるか？

---

## 次のアクション

ユーザーからのフィードバックを元に：

1. **フェーズ分けの最終化**
   - 各Phaseの範囲確定
   - 移行基準明確化

2. **Phase 2計画書作成**
   - 詳細なタスク分解
   - 工数見積もり
   - スケジュール

3. **ADR作成**
   - フェーズ分けの決定理由を記録
   - 代替案と検討結果

4. **ロードマップ更新**
   - 全体スケジュールの可視化
   - マイルストーン設定

---

**記録者:** Claude Code
**ステータス:** ディスカッション進行中
**次回:** フィードバック受領後、Phase 2詳細計画策定

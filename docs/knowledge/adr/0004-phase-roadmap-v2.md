# ADR-0004: Oiduna v2 Phase 2以降のロードマップ

## ステータス

承認済み

## 日付

- 作成: 2026-02-22
- 承認: 2026-02-22

## コンテキスト

### 問題

Phase 1完了後、Phase 2以降の機能が多岐にわたり、優先順位付けとフェーズ分けが必要になりました。初期提案では以下の課題がありました：

1. Web UIの位置づけが不明確
2. 最適化フェーズの扱い
3. Rust化のタイミング
4. 各Phaseの範囲が曖昧

### システムの本質（重要な洞察）

ユーザーからの重要なフィードバック：

> このシステムの本質は**サーバーとして叩かれたAPIに沿ってライブコーディングのループや各種処理を行うこと**が本質です。Web UIはありますがそれはwifiルーターの設定画面程度の意義であり、主たる目的は**ライブコーディング演奏者と電子楽器の「追い綱」**となることです。

**この洞察から導かれる方針：**
- API中心のシステム設計
- Web UIは管理補助機能（優先度低）
- 演奏中の即時性・信頼性が最重要
- 実際の演奏での使用を重ねてから最適化判断

### 要件

- **機能要件:**
  - 本番演奏で安定運用可能な品質
  - 複数演奏者・自動化スクリプト対応
  - 演奏中の即時性確保

- **非機能要件:**
  - タイミング精度: ±5ms以内
  - 高負荷時の安定性
  - デバッグ・トラブルシューティングの容易性

## 決定事項

### フェーズ構成

```
Phase 1 (完了) - 基盤構築
    ↓
Phase 2 (2-3週間) - 信頼性・品質向上
    ↓
Phase 2.5 (1-2週間) - 最適化・測定（独立フェーズ）
    ↓
Phase 3 (3-4週間) - 機能拡張（API中心）
    ↓
実演奏・ブラッシュアップ期間
    ↓
Phase 4 (条件付き) - Rust化・高度な最適化
```

---

## Phase 2: 信頼性・品質向上（本番運用可能レベル）

**期間:** 2-3週間
**優先度:** 高
**目標:** 本番演奏で安定運用できる品質に到達

**Phase 2 構成:**
- Phase 2.0: リクエストID導入（2-3日）
- Phase 2.1: 開発ツール（8-10日）
- Phase 2.2: 検証・品質向上（7-10日）

---

### Phase 2.0: リクエストID導入（必須）

**工数:** 2-3日
**優先度:** 最高

**内容:**
- UUID生成による一意なリクエスト識別
- SuperCollider側のリクエストID対応
- 確認マッチングの修正（名前→IDベース）
- 優先度付きキュー（基本実装）
- 全エンドポイント対応

**成果物:**
- リクエストID対応API
- SuperColliderスクリプト更新（v2対応）
- 優先度付きキュークラス
- ユニットテスト追加

**詳細:** [リクエストIDシステム設計](../research/request-id-system-design.md)

**完了条件:**
- ✓ 全エンドポイントがリクエストID対応
- ✓ 同時リクエストが正しく処理される
- ✓ 優先度付きキューが動作

---

### Phase 2.1: 開発ツール（推奨）

**工数:** 8-10日
**優先度:** 高
**目標:** Oiduna単体での開発・テストを加速

**背景:**
- MARS DSL開発進捗がOidunaテストのボトルネックになる可能性
- 人間（開発者）が手軽にOidunaを確認する手段が必要
- Claude Codeからの自動化にも対応

**実装内容:**

#### 2.1-A. oiduna_client（Pythonライブラリ）

**工数:** 3-4日

**内容:**
- Oiduna HTTP APIをラップする非同期クライアントライブラリ
- Pydanticモデルで型安全なAPI提供
- httpxベースの非同期実装

**提供クライアント:**
- `OidunaClient` - 統合クライアント
- `PatternClient` - パターン操作
- `SynthDefClient` - SynthDefロード
- `SampleClient` - サンプル管理
- `HealthClient` - ヘルスチェック

**成果物:**
- packages/oiduna_client/
- ユニットテスト（カバレッジ80%+）

#### 2.1-B. oiduna_cli（CLIツール）

**工数:** 3-4日

**内容:**
- コマンドモード + インタラクティブREPLの2モード
- Clickフレームワークベース
- Rich/prompt-toolkitでUX向上

**提供コマンド:**
```bash
oiduna play <pattern>               # パターン実行
oiduna validate <pattern>           # 検証のみ
oiduna synthdef load <file>         # SynthDefロード
oiduna sample load <cat> <path>     # サンプルロード
oiduna sample list                  # バッファリスト
oiduna status                       # ヘルスチェック
oiduna repl                         # インタラクティブモード
```

**Claude Code対応:**
- `--json` フラグで機械可読なJSON出力
- 明確な終了コード（0/1/2/3/4）
- stderr/stdoutの適切な使い分け

**成果物:**
- packages/oiduna_cli/
- CLIテスト

#### 2.1-C. サンプルファイル

**工数:** 1日

**内容:**
- Oiduna IR形式のパターンファイル（4種類）
- SynthDefファイル（3種類）
- 即座にテスト可能な状態で提供

**成果物:**
- samples/patterns/（basic_kick.json, simple_beat.json, etc.）
- samples/synthdefs/（acid.scd, pad.scd, kick.scd）
- README.md（使用方法）

#### 2.1-D. ドキュメント整備

**工数:** 1日

**成果物:**
- oiduna_client APIリファレンス
- oiduna_cli 使用ガイド
- Claude Code統合例
- ADR-0005作成

**詳細:** [oiduna-cli設計](../research/oiduna-cli-design.md)、[実装仕様書](../handoff/oiduna-client-cli-implementation-spec.md)、[ADR-0005](./0005-oiduna-client-cli-design.md)

**Phase 2.1完了条件:**
- ✓ oiduna_clientで全エンドポイントにアクセス可能
- ✓ oiduna_cliで全コマンド動作
- ✓ REPLモード動作
- ✓ JSON出力モード動作（Claude Code対応）
- ✓ サンプルファイルで即座にテスト可能

---

### Phase 2.2: 検証・品質向上（必須）

**工数:** 7-10日
**優先度:** 高

**前提:** Phase 2.0, 2.1完了（oiduna_cliでテスト可能な状態）

#### 2.2-A. SynthDef基本検証

**工数:** 2-3日

**内容:**
- 構文チェック（基本的なパース）
- コード長チェック（上限設定）
- 危険なコードパターン検出（system呼び出し等）

**成果物:**
- SynthDefValidatorクラス
- バリデーションエラーの明確なメッセージ

#### 2.2-B. サンプルメタデータ

**工数:** 2-3日

**内容:**
- サンプル長さ取得（pysoundfile等）
- フォーマット・チャンネル数取得
- メタデータキャッシュ

**成果物:**
- GET /superdirt/samples/{category}/metadata
- キャッシュ機構

#### 2.2-C. エラーハンドリング強化

**工数:** 2日

**内容:**
- より詳細なエラーメッセージ
- エラー種別の分類
- リトライ機構（一時的エラー対応）

**成果物:**
- エラー分類enum
- リトライロジック

#### 2.2-D. 統合テスト

**工数:** 3-4日

**内容:**
- E2Eテストスイート構築
- SuperColliderとの統合テスト
- CI/CDパイプライン基盤

**成果物:**
- E2Eテストスイート
- GitHub Actions設定

**Phase 2.2完了条件:**
- ✓ SynthDef検証機能動作
- ✓ サンプルメタデータAPI動作
- ✓ E2Eテストが全て通過
- ✓ 高負荷テストをクリア（100同時リクエスト等）

---

### Phase 2全体の完了条件

- ✓ Phase 2.0: リクエストID完全対応
- ✓ Phase 2.1: oiduna_client + oiduna_cli完成
- ✓ Phase 2.2: 検証・品質向上完了
- ✓ E2Eテストが全て通過
- ✓ ドキュメント更新完了

### Phase 2成果物

- リクエストID対応API（v2.1）
- oiduna_client（Pythonライブラリ）
- oiduna_cli（CLIツール）
- サンプルファイル（IR + SynthDef）
- SynthDef検証機能
- サンプルメタデータAPI
- E2Eテストスイート
- CI/CDパイプライン
- Phase 2完了レポート

---

## Phase 2.5: 最適化・測定（独立フェーズ）

**期間:** 1-2週間
**優先度:** 中
**目標:** パフォーマンス特性の把握、Rust化判断材料の収集

### 実装内容

#### 2.5.1. タイミング精度測定（必須）

**工数:** 3-4日

**内容:**
- タイミング精度測定ツール実装
- ベンチマーク確立（±5ms基準）
- 長時間安定性テスト（1時間+）
- GC影響の測定

**成果物:**
- TimingBenchmark クラス
- タイミング精度レポート
- 測定データ（CSV/JSON）

#### 2.5.2. プロファイリング（必須）

**工数:** 2-3日

**内容:**
- cProfile/py-spyによるプロファイリング
- ボトルネック特定
- メモリプロファイリング

**成果物:**
- プロファイリングレポート
- ボトルネック箇所のリスト

#### 2.5.3. Python最適化（推奨）

**工数:** 3-5日

**内容:**
- 特定されたボトルネックの改善
- asyncio最適化
- 不要なアロケーション削減

**成果物:**
- 最適化されたコード
- パフォーマンス改善レポート

#### 2.5.4. Rust化判断（必須）

**工数:** 1日（判断のみ）

**判断基準:**

**Rust化を進める条件（すべて満たす場合）:**
1. タイミング精度が±5msを超える頻度が高い（5%以上）
2. Python最適化で改善が見込めない
3. 開発コストに見合う改善が期待できる

**Rust化を見送る条件（いずれか満たす場合）:**
1. タイミング精度が±5ms以内を95%以上達成
2. Python最適化で十分な改善が見られた
3. 実演奏でタイミング問題が顕在化していない

**成果物:**
- Rust化判断レポート（ADR）
- Phase 4実装計画（Rust化する場合）

### Phase 2.5完了条件

- ✓ タイミング精度ベンチマーク完了
- ✓ ボトルネック特定・文書化完了
- ✓ Python最適化実施完了
- ✓ Rust化の要否を決定（ADR作成）

### Phase 2.5成果物

- タイミング精度レポート
- パフォーマンスベンチマーク
- 最適化されたコード
- Rust化判断ADR

---

## Phase 3: 機能拡張（API中心）

**期間:** 3-4週間
**優先度:** 中
**目標:** 演奏の幅を広げる機能拡張

### 実装内容

#### 3.1. SynthDef管理機能（推奨）

**工数:** 3-4日

**内容:**
- GET /superdirt/synthdefs - ロード済みSynthDefリスト
- DELETE /superdirt/synthdef/{name} - アンロード
- GET /superdirt/synthdef/{name}/info - 詳細情報

**成果物:**
- SynthDef管理API
- ドキュメント

#### 3.2. サンプル管理機能（推奨）

**工数:** 3-4日

**内容:**
- GET /superdirt/samples - カテゴリ一覧
- GET /superdirt/samples/{category} - カテゴリ内サンプル一覧
- DELETE /superdirt/samples/{category} - アンロード
- GET /superdirt/samples/search - 検索

**成果物:**
- サンプル管理API
- ドキュメント

#### 3.3. WebSocket統合（推奨）

**工数:** 4-5日

**内容:**
- WebSocket基盤構築
- サンプルロード進捗通知
- エラー通知（リアルタイム）
- パフォーマンスメトリクスストリーム

**成果物:**
- WebSocket エンドポイント
- 通知プロトコル仕様

#### 3.4. エフェクト管理（オプション）

**工数:** 3-4日

**内容:**
- エフェクトチェーン管理
- エフェクトプリセット
- パラメータのライブ変更

**成果物:**
- エフェクト管理API

#### 3.5. 最小限の管理UI（オプション）

**工数:** 3-5日

**内容:**
- シンプルなステータスダッシュボード
- ヘルスチェック画面
- 基本的な設定画面
- ログビューア

**方針:**
- 「wifiルーターの設定画面」程度の位置づけ
- 演奏には使わない管理補助機能
- モダンなフレームワーク不要（シンプルなHTML/JS）

**成果物:**
- 管理UI（最小限）

### Phase 3完了条件

- ✓ SynthDef/サンプル管理API完成
- ✓ WebSocket通知機能動作
- ✓ ドキュメント更新完了
- ✓ 管理UI（最小限）完成

### Phase 3成果物

- 機能拡張API（v3.0）
- WebSocket通知機能
- 管理UI（オプション）
- Phase 3完了レポート

---

## 実演奏・ブラッシュアップ期間

**期間:** 数ヶ月〜1年
**目標:** 実際の演奏での使用感確認、問題点の洗い出し

### 活動内容

1. **実演奏での使用**
   - ライブコーディング演奏での使用
   - 問題点・改善点の記録

2. **フィードバック収集**
   - タイミング問題の有無
   - 使い勝手の問題
   - 機能不足の洗い出し

3. **マイナー改善**
   - バグフィックス
   - 小さな機能追加
   - ドキュメント改善

4. **Phase 4判断**
   - Rust化の必要性再評価
   - Phase 2.5の測定結果と実演奏での実感を照合

---

## Phase 4: Rust化・高度な最適化（条件付き）

**開始条件:** 実演奏で以下のいずれかが確認された場合

1. タイミング揺らぎが演奏に支障をきたす
2. CPU使用率が高すぎて他の処理に影響
3. Phase 2.5の測定で明確な問題が判明

**期間:** 1-2ヶ月
**優先度:** 条件次第
**目標:** 超高精度タイミングエンジン

### 実装内容

#### 4.1. タイミングエンジンRust化

**工数:** 1-2ヶ月

**内容:**
- タイミングコアのみRust実装
- PyO3によるPython統合
- パフォーマンス比較
- フォールバック機構

**成果物:**
- Rustタイミングエンジン
- PyO3バインディング
- パフォーマンス比較レポート

#### 4.2. スケーラビリティ対応（オプション）

**工数:** 2-3週間

**内容:**
- 水平スケーリング対応
- ロードバランシング
- セッション管理

### Phase 4完了条件

- ✓ Rustタイミングエンジン動作
- ✓ Python版と同等以上の機能
- ✓ タイミング精度向上確認
- ✓ 実演奏で問題なし

---

## 理由

### Phase 2.5を独立フェーズにする理由

1. **明確な目的:** 測定とRust化判断に集中
2. **柔軟性:** Rust化不要ならPhase 4をスキップ可能
3. **データドリブン:** 測定データに基づく意思決定

### Web UIを最小限にする理由

1. **システムの本質:** API中心、「追い綱」としての役割
2. **優先度:** 演奏機能の方が重要
3. **リソース:** 限られた開発時間を重要機能に集中
4. **実際の使用:** 演奏者はCLI/スクリプトで操作

### 実演奏期間を設ける理由

1. **実際の問題把握:** 測定だけでは分からない使用感
2. **Rust化の慎重な判断:** 大きな投資前に実績確認
3. **段階的改善:** 小さな改善を積み重ねる

## 代替案

### 案1: Web UI優先

**概要:** Phase 3でWeb UIをフル実装

**長所:**
- ユーザー体験向上
- デモがしやすい

**短所:**
- 開発期間延長（+3-4週間）
- システムの本質からズレる
- 演奏には使わない機能に時間を費やす

**却下理由:**
システムの本質は「API中心の追い綱」であり、Web UIは管理補助機能に過ぎない。

### 案2: Rust化を即座に実施

**概要:** Phase 2完了後すぐにRust化

**長所:**
- 早期に高精度化達成
- 将来の問題を予防

**短所:**
- 測定前の最適化（問題が顕在化していない）
- 開発コスト高（1-2ヶ月）
- 実演奏での問題が分からない状態で判断

**却下理由:**
「測定してから最適化」の原則に反する。実演奏での実績がない段階で大きな投資はリスク。

### 案3: Phase 2.5をPhase 2に統合

**概要:** 測定を Phase 2 に含める

**長所:**
- フェーズ数が少ない
- Phase 2完了時に測定済み

**短所:**
- Phase 2が長期化（4-5週間）
- 目的が曖昧（品質向上 vs 測定）
- Rust化判断のタイミングが不明確

**却下理由:**
Phase 2は「本番運用可能レベル」、Phase 2.5は「測定・最適化」と目的が異なる。分離した方が明確。

## 影響

### プラスの影響

- **明確なロードマップ:** 各Phaseの目的が明確
- **段階的改善:** 小さなステップで確実に前進
- **データドリブン:** 測定に基づく意思決定
- **リソース最適化:** 重要な機能に集中

### マイナスの影響

- **Web UI遅延:** フル機能のWeb UIは当面提供されない
- **Rust化遅延:** 高精度化は実演奏後まで待つ

### リスク

- **リスク:** 実演奏でタイミング問題が頻発
  - **軽減策:** Phase 2.5で測定・最適化実施

- **リスク:** Web UIがないことでユーザー離れ
  - **軽減策:** 管理UIは最小限提供、API中心の価値を訴求

- **リスク:** Phase 4実施時期が不明確
  - **軽減策:** 実演奏期間で明確な判断基準設定

## 検証方法

### Phase 2完了時

- E2Eテストが全て通過
- 高負荷テストをクリア
- 本番環境での動作確認

### Phase 2.5完了時

- タイミング精度レポート完成
- Rust化判断完了（ADR作成）

### Phase 3完了時

- 実演奏で使用開始
- フィードバック記録開始

### Phase 4判断時

- 実演奏での問題記録
- Phase 2.5測定データとの照合
- コスト対効果の評価

## 関連するADR

- [ADR-0001: supernova統合](./0001-supernova-multicore-integration.md)
- [ADR-0002: OSC確認プロトコル](./0002-osc-confirmation-protocol.md)
- [ADR-0003: Python継続](./0003-python-timing-engine-phase1.md)
- [ADR-0005: oiduna_client + CLI設計](./0005-oiduna-client-cli-design.md)

## 参考資料

- [Phase Planning Discussion](../discussions/2026-02-22-phase-planning.md)
- [リクエストIDシステム設計](../research/request-id-system-design.md)
- [Phase 1実装サマリー](../../oiduna/docs/PHASE1_IMPLEMENTATION_SUMMARY.md)

## メモ

### Phase 2.5後の判断フロー

```
Phase 2.5完了
    ↓
タイミング精度測定結果確認
    ↓
    ├─ ±5ms以内 95%以上達成
    │   ↓
    │   Phase 3へ進む（Rust化見送り）
    │   ↓
    │   実演奏期間
    │       ↓
    │       ├─ タイミング問題なし → Phase 4スキップ
    │       └─ タイミング問題あり → Phase 4実施
    │
    └─ ±5ms超が頻発
        ↓
        Python最適化実施
            ↓
            ├─ 改善 → Phase 3へ
            └─ 改善なし → Phase 4実施を検討
```

### Web UI実装の将来

- Phase 3で最小限の管理UI
- Phase 4以降で必要に応じて拡充
- ただし「追い綱」としての本質を忘れない
- フル機能UIは別プロジェクトとして切り離しも検討

## 履歴

- 2026-02-22: 初稿作成（ステータス: 提案中）
- 2026-02-22: ユーザーフィードバック反映、承認（ステータス: 承認済み）
- 2026-02-22: Phase 2.1追加（開発ツール: oiduna_client + oiduna_cli）、Phase 2を3サブフェーズに再編成
